#!/bin/bash

# p7m-extract - Extract content from PKCS#7 (.p7m) files
# Compatible with macOS M4

VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to display usage
usage() {
    cat << EOF
p7m-extract v${VERSION} - Extract content from PKCS#7 (.p7m) files

USAGE:
    p7m-extract [OPTIONS] <input.p7m> [output_file]

OPTIONS:
    -h, --help          Show this help message
    -v, --version       Show version information
    -i, --info          Display information about the p7m file without extracting
    -o, --output FILE   Specify output file (if not provided, auto-generated)

EXAMPLES:
    # Extract to auto-generated filename
    p7m-extract document.pdf.p7m

    # Extract to specific filename
    p7m-extract document.pdf.p7m extracted_document.pdf
    p7m-extract -o output.pdf document.pdf.p7m

    # Show info about the p7m file
    p7m-extract -i document.pdf.p7m

DESCRIPTION:
    This tool extracts the original content from PKCS#7 signed/encrypted
    message files (.p7m). It uses OpenSSL to decode the PKCS#7 structure
    and extract the embedded document.

EOF
    exit 0
}

# Function to display version
version() {
    echo "p7m-extract version ${VERSION}"
    exit 0
}

# Function to show info about p7m file
show_info() {
    local input_file="$1"
    
    echo -e "${GREEN}=== PKCS#7 File Information ===${NC}"
    echo -e "${YELLOW}File:${NC} $input_file"
    echo ""
    
    # Try to get information about the PKCS#7 structure
    if openssl pkcs7 -in "$input_file" -inform DER -print_certs -noout 2>/dev/null; then
        echo ""
    else
        echo -e "${YELLOW}Note: Could not parse certificate information${NC}"
    fi
    
    # Show basic file info
    echo -e "${YELLOW}File size:${NC} $(ls -lh "$input_file" | awk '{print $5}')"
    
    exit 0
}

# Function to extract p7m file
extract_p7m() {
    local input_file="$1"
    local output_file="$2"
    
    # Check if input file exists
    if [[ ! -f "$input_file" ]]; then
        echo -e "${RED}Error: Input file '$input_file' not found${NC}" >&2
        exit 1
    fi
    
    # Generate output filename if not provided
    if [[ -z "$output_file" ]]; then
        # Remove .p7m extension if present
        output_file="${input_file%.p7m}"
        
        # If the filename didn't change (no .p7m extension), append .extracted
        if [[ "$output_file" == "$input_file" ]]; then
            output_file="${input_file}.extracted"
        fi
    fi
    
    echo -e "${GREEN}Extracting PKCS#7 file...${NC}"
    echo -e "Input:  ${YELLOW}$input_file${NC}"
    echo -e "Output: ${YELLOW}$output_file${NC}"
    echo ""
    
    # Try to extract using OpenSSL
    # First try DER format (most common for .p7m files)
    if openssl smime -verify -in "$input_file" -inform DER -noverify -out "$output_file" 2>/dev/null; then
        echo -e "${GREEN}✓ Successfully extracted content to: $output_file${NC}"
        echo -e "Size: $(ls -lh "$output_file" | awk '{print $5}')"
        exit 0
    fi
    
    # If DER fails, try PEM format
    if openssl smime -verify -in "$input_file" -inform PEM -noverify -out "$output_file" 2>/dev/null; then
        echo -e "${GREEN}✓ Successfully extracted content to: $output_file${NC}"
        echo -e "Size: $(ls -lh "$output_file" | awk '{print $5}')"
        exit 0
    fi
    
    # If both fail, try pkcs7 command
    if openssl pkcs7 -in "$input_file" -inform DER -print_certs -out "$output_file" 2>/dev/null; then
        echo -e "${GREEN}✓ Successfully extracted content to: $output_file${NC}"
        echo -e "Size: $(ls -lh "$output_file" | awk '{print $5}')"
        exit 0
    fi
    
    echo -e "${RED}✗ Failed to extract content${NC}" >&2
    echo -e "${YELLOW}The file may be encrypted or in an unsupported format${NC}" >&2
    exit 1
}

# Parse command line arguments
INFO_MODE=false
OUTPUT_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -v|--version)
            version
            ;;
        -i|--info)
            INFO_MODE=true
            shift
            ;;
        -o|--output)
            OUTPUT_FILE="$2"
            shift 2
            ;;
        -*)
            echo -e "${RED}Error: Unknown option $1${NC}" >&2
            echo "Use -h or --help for usage information"
            exit 1
            ;;
        *)
            if [[ -z "$INPUT_FILE" ]]; then
                INPUT_FILE="$1"
            elif [[ -z "$OUTPUT_FILE" ]]; then
                OUTPUT_FILE="$1"
            else
                echo -e "${RED}Error: Too many arguments${NC}" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

# Check if input file was provided
if [[ -z "$INPUT_FILE" ]]; then
    echo -e "${RED}Error: No input file specified${NC}" >&2
    echo "Use -h or --help for usage information"
    exit 1
fi

# Execute based on mode
if [[ "$INFO_MODE" == true ]]; then
    show_info "$INPUT_FILE"
else
    extract_p7m "$INPUT_FILE" "$OUTPUT_FILE"
fi
